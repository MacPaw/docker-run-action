name: Docker Run Action Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Run docker action and set output for testing
        uses: ./
        id: run-docker
        with:
          image: docker:20.10.3
          run: |
            echo "::set-output name=docker-version::`echo $DOCKER_VERSION`"
      - name: Test the output
        uses: actions/github-script@v3
        with:
          script: |
            const dockerVersion = '${{ steps.run-docker.outputs.docker-version }}';
            if (dockerVersion !== '20.10.3') {
              core.setFailed(`Smoke Test Failed`);
            }
  volume-mount-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Create File to be mounted
        run: echo "some text" > someFile
      - name: Run docker action with mounted workspace
        uses: ./
        id: run-docker
        with:
          image: docker
          options: -v ${{ github.workspace }}:/work
          run: |
            echo "::set-output name=file-contents::`cat /work/someFile`"
      - name: Check if file contents match
        uses: actions/github-script@v3
        with:
          script: |
            const fileContents = '${{ steps.run-docker.outputs.file-contents }}';
            if (fileContents !== 'some text') {
              core.setFailed(`Unable to mount workspace volume`);
            }
  container-network-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 5s --health-timeout 5s --health-retries 10
    steps:
      - uses: actions/checkout@v6
      - name: Run docker action and test network connection
        uses: ./
        with:
          image: postgres
          run: >
            pg_isready -d test -U test -h postgres -p ${{ job.services.postgres.ports[5432] }}
          options: >
            -e PGPASSWORD=test
  multiline-command-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Test multiline commands with variable persistence
        uses: ./
        id: multiline-test
        with:
          image: alpine:latest
          run: |
            echo "Starting multiline test"
            VAR1="first_value"
            VAR2="second_value"
            echo "VAR1=$VAR1"
            echo "VAR2=$VAR2"
            COMBINED="${VAR1}_${VAR2}"
            echo "::set-output name=combined::$COMBINED"
            echo "::set-output name=line-count::`echo -e 'line1\nline2\nline3' | wc -l`"
      - name: Verify multiline command outputs
        uses: actions/github-script@v3
        with:
          script: |
            const combined = '${{ steps.multiline-test.outputs.combined }}';
            const lineCount = '${{ steps.multiline-test.outputs.line-count }}';
            if (combined !== 'first_value_second_value') {
              core.setFailed(`Variable persistence failed: expected 'first_value_second_value', got '${combined}'`);
            }
            if (lineCount !== '3') {
              core.setFailed(`Line count failed: expected '3', got '${lineCount}'`);
            }
      - name: Test multiline commands with complex operations
        uses: ./
        id: complex-multiline
        with:
          image: alpine:latest
          run: |
            apk add --no-cache jq
            echo '{"key":"value","count":42}' > /tmp/test.json
            VALUE=$(cat /tmp/test.json | jq -r '.key')
            COUNT=$(cat /tmp/test.json | jq -r '.count')
            echo "::set-output name=json-value::$VALUE"
            echo "::set-output name=json-count::$COUNT"
      - name: Verify complex multiline outputs
        uses: actions/github-script@v3
        with:
          script: |
            const jsonValue = '${{ steps.complex-multiline.outputs.json-value }}';
            const jsonCount = '${{ steps.complex-multiline.outputs.json-count }}';
            if (jsonValue !== 'value') {
              core.setFailed(`JSON parsing failed: expected 'value', got '${jsonValue}'`);
            }
            if (jsonCount !== '42') {
              core.setFailed(`JSON count failed: expected '42', got '${jsonCount}'`);
            }
